---
phase: 01-data-migration-workflow-simplification
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - crkva/registar/management/commands/migrate_data.py
autonomous: true

must_haves:
  truths:
    - "Running 'manage.py migrate_data --dummy' generates dummy development data in a single command"
    - "Running 'manage.py migrate_data --real' imports from crkva.zip without manual extraction"
    - "Running 'manage.py migrate_data --real --dry-run' validates data without writing to database"
    - "Progress output shows which migration step is running and how many records processed"
    - "Summary report at end shows total records created, skipped, and any errors per entity type"
    - "The --real flag accepts an optional path argument or defaults to ./crkva.zip"
  artifacts:
    - path: "crkva/registar/management/commands/migrate_data.py"
      provides: "Unified migration command orchestrating all data import steps"
      contains: "class Command"
  key_links:
    - from: "crkva/registar/management/commands/migrate_data.py"
      to: "crkva/registar/management/commands/load_dbf.py"
      via: "call_command('load_dbf', src_zip=...)"
      pattern: "call_command.*load_dbf"
    - from: "crkva/registar/management/commands/migrate_data.py"
      to: "crkva/registar/management/commands/migracija_krstenja.py"
      via: "call_command('migracija_krstenja')"
      pattern: "call_command.*migracija"
    - from: "crkva/registar/management/commands/migrate_data.py"
      to: "crkva/registar/management/commands/unosi.py"
      via: "call_command('unosi') for reference data"
      pattern: "call_command.*unos"
---

<objective>
Create the unified `manage.py migrate_data` management command that orchestrates the entire data migration workflow through `--dummy` and `--real` flags, with `--dry-run` validation, progress indicators, and summary reporting.

Purpose: Replaces the current 4-5 manual command workflow with a single entry point. This is the core deliverable of Phase 1.
Output: `crkva/registar/management/commands/migrate_data.py` - a fully functional orchestration command.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-data-migration-workflow-simplification/01-01-SUMMARY.md

@crkva/registar/management/commands/load_dbf.py
@crkva/registar/management/commands/unosi.py
@crkva/registar/management/commands/base_migration.py
@crkva/registar/management/commands/migracija_krstenja.py
@crkva/registar/management/commands/migracija_vencanja.py
@crkva/registar/management/commands/migracija_parohijana.py
@crkva/registar/management/commands/migracija_slava.py
@crkva/registar/management/commands/migracija_svestenika.py
@crkva/registar/management/commands/migracija_ukucana.py
@crkva/registar/management/commands/migracija_ukucana_parohijana.py
@crkva/registar/management/commands/migracija_ulica.py
@crkva/registar/management/commands/unos_krstenja.py
@crkva/registar/management/commands/unos_vencanja.py
@crkva/registar/management/commands/unos_drzava.py
@crkva/registar/management/commands/unos_mesta.py
@crkva/registar/management/commands/unos_svestenika.py
@crkva/registar/management/commands/unos_adresa.py
@crkva/registar/management/commands/unos_ulica.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement migrate_data command with --dummy and --real flags</name>
  <files>crkva/registar/management/commands/migrate_data.py</files>
  <action>
Create `crkva/registar/management/commands/migrate_data.py` with:

1. **Argument parser** with mutually exclusive group:
   - `--dummy` (action='store_true'): Load dummy development data
   - `--real` (nargs='?', const='crkva.zip', default=None): Import from crkva.zip. Accepts optional path; defaults to `./crkva.zip` relative to project root.
   - `--dry-run` (action='store_true'): Validate without saving (works with both --dummy and --real)
   - `--skip-staging` (action='store_true'): Skip the `load_dbf` step (reuse existing staging tables)
   - `--keep-staging` (action='store_true'): Don't drop staging tables after migration

2. **`handle()` method** that:
   - Validates arguments (exactly one of --dummy or --real)
   - For `--real`: checks crkva.zip exists at given path, raises CommandError if not found
   - Calls `_migrate_real()` or `_migrate_dummy()` based on flag
   - Wraps entire workflow in `@atomic` transaction (unless --dry-run, which should also be atomic but rolls back at end)
   - Prints summary report at the end

3. **`_migrate_real(self, zip_path, dry_run, skip_staging, keep_staging)` method:**

   Step sequence (mirrors documented order in MIGRACIJA.md):
   ```
   a. load_dbf --src_zip <zip_path>     (unless --skip-staging)
   b. unosi                              (reference data: narodnosti, veroispovesti, zanimanja, slave, eparhije)
   c. unos_drzava                        (countries)
   d. unos_mesta                         (cities/towns)
   e. migracija_slava                    (slava days)
   f. migracija_ulica                    (streets)
   g. migracija_svestenika               (clergy)
   h. migracija_parohijana               (parishioners)
   i. migracija_ukucana                  (household members)
   j. migracija_ukucana_parohijana       (household-parishioner links)
   k. migracija_krstenja                 (baptisms)
   l. migracija_vencanja                 (weddings)
   ```

   For each step:
   - Print step number and name: `self.stdout.write(f"\n[{step}/{total}] Миграција: {name}...")`
   - Use `call_command()` to invoke the existing command
   - Capture stdout to count records (or wrap in try/except and report success/failure)
   - Track results in a dict: `{'step': name, 'status': 'ok'|'error'|'skipped', 'message': str}`

   For `--dry-run`: Set `savepoint` before each migration step. After validation, rollback the savepoint. Note: This is complex because existing commands save directly. For the initial implementation, dry-run with `--real` should:
   - Run `load_dbf` normally (to staging tables)
   - Skip actual migration commands
   - Validate staging table row counts
   - Report what WOULD be migrated
   - Drop staging tables at end (unless --keep-staging)

4. **`_migrate_dummy(self, dry_run)` method:**

   Step sequence:
   ```
   a. unosi                              (reference data)
   b. unos_drzava                        (countries)
   c. unos_mesta                         (cities/towns)
   d. unos_ulica                         (streets - random)
   e. unos_adresa                        (addresses - random)
   f. unos_svestenika                    (clergy - random)
   g. unos_krstenja                      (baptisms - random)
   h. unos_vencanja                      (weddings - random)
   ```

   For `--dry-run`: Just print what would be generated without executing.

5. **`_print_summary(self, results)` method:**
   - Print formatted table of all steps with status
   - Use `self.style.SUCCESS`, `self.style.ERROR`, `self.style.WARNING` for coloring
   - Show total duration (track start time in handle())
   - Format:
   ```
   ═══════════════════════════════════════
   ИЗВЕШТАЈ О МИГРАЦИЈИ
   ═══════════════════════════════════════
   Корак                      Статус
   ───────────────────────────────────────
   1. Учитавање DBF           ✓ Успешно
   2. Референтни подаци       ✓ Успешно
   ...
   ═══════════════════════════════════════
   Укупно време: 2m 34s
   ```

6. **Error handling:**
   - If any step fails, log the error but continue to next step (unless it's a dependency - load_dbf failure should abort)
   - Accumulate errors in results dict
   - At end, if any errors, exit with code 1
  </action>
  <verify>
    `cd /Users/milan.jelisavcic/Projects/spc-registar/crkva && python manage.py migrate_data --help` shows all flags.
    `cd /Users/milan.jelisavcic/Projects/spc-registar/crkva && python manage.py migrate_data` shows error about requiring --dummy or --real.
    `cd /Users/milan.jelisavcic/Projects/spc-registar/crkva && python manage.py migrate_data --real --dry-run` runs without crash (may show "crkva.zip not found" if file not present).
  </verify>
  <done>
    `manage.py migrate_data` command exists with `--dummy`, `--real`, `--dry-run`, `--skip-staging`, and `--keep-staging` flags. Help text is in Serbian. Command validates arguments and orchestrates the full migration sequence. Summary report prints at end of run.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify command works end-to-end with dummy data</name>
  <files>crkva/registar/management/commands/migrate_data.py</files>
  <action>
Test the command end-to-end in the Docker environment:

1. Run `docker compose run --rm app sh -c "python manage.py migrate_data --dummy"` and verify:
   - All dummy data generation steps execute in order
   - Summary report prints at end with step counts
   - No errors (or only expected warnings)

2. If the Docker environment is not available, run locally:
   `cd crkva && python manage.py migrate_data --dummy`

3. Run `python manage.py migrate_data --dummy --dry-run` and verify:
   - Outputs what WOULD be generated
   - No data actually written to database

4. Fix any issues discovered during testing:
   - Command ordering issues (dependency violations)
   - Missing imports
   - Incorrect call_command arguments
   - Summary report formatting

5. Run existing test suite to confirm no regressions:
   `python manage.py test registar`
  </action>
  <verify>
    `cd /Users/milan.jelisavcic/Projects/spc-registar/crkva && python manage.py migrate_data --dummy 2>&1 | tail -20` shows summary report with all steps succeeded.
    `cd /Users/milan.jelisavcic/Projects/spc-registar/crkva && python manage.py test registar 2>&1 | tail -3` shows no regressions.
  </verify>
  <done>
    `manage.py migrate_data --dummy` executes all dummy data generation steps successfully. `--dry-run` mode works. Summary report shows correct status for all steps. Existing tests pass.
  </done>
</task>

</tasks>

<verification>
1. `python manage.py migrate_data --help` shows usage with all flags
2. `python manage.py migrate_data --dummy` generates development data end-to-end
3. `python manage.py migrate_data --dummy --dry-run` validates without saving
4. `python manage.py migrate_data --real --dry-run` validates crkva.zip path
5. Summary report prints with step-by-step status
6. `python manage.py test registar` passes with no regressions
</verification>

<success_criteria>
- Single `migrate_data` command replaces 4-5 manual steps
- Both `--dummy` and `--real` workflows execute correctly
- `--dry-run` mode validates without database writes
- Summary report shows records processed per step
- Backward compatibility: existing individual commands still work
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-migration-workflow-simplification/01-02-SUMMARY.md`
</output>
