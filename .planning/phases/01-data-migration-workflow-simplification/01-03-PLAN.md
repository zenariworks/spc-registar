---
phase: 01-data-migration-workflow-simplification
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - crkva/registar/tests/test_migrate_data_command.py
  - docs/MIGRACIJA.md
autonomous: true

must_haves:
  truths:
    - "Integration tests verify migrate_data --dummy runs without errors"
    - "Integration tests verify migrate_data --dry-run produces no database writes"
    - "Integration tests verify argument validation (missing flags, invalid paths)"
    - "MIGRACIJA.md documents the new single-command workflow in Serbian Cyrillic"
    - "MIGRACIJA.md explains --dummy vs --real vs --dry-run usage"
  artifacts:
    - path: "crkva/registar/tests/test_migrate_data_command.py"
      provides: "Integration tests for migrate_data command"
      contains: "class TestMigrateDataCommand"
    - path: "docs/MIGRACIJA.md"
      provides: "Updated migration documentation in Serbian Cyrillic"
      contains: "migrate_data"
  key_links:
    - from: "crkva/registar/tests/test_migrate_data_command.py"
      to: "crkva/registar/management/commands/migrate_data.py"
      via: "call_command('migrate_data', ...)"
      pattern: "call_command.*migrate_data"
---

<objective>
Write integration tests for the `migrate_data` command and update `docs/MIGRACIJA.md` to document the new simplified workflow.

Purpose: Ensures the unified command is tested for reliability and that documentation enables priests/parish staff to use the new workflow independently.
Output: Test suite for the command + updated migration documentation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-data-migration-workflow-simplification/01-01-SUMMARY.md
@.planning/phases/01-data-migration-workflow-simplification/01-02-SUMMARY.md

@crkva/registar/management/commands/migrate_data.py
@crkva/registar/tests/test_integration.py
@docs/MIGRACIJA.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write integration tests for migrate_data command</name>
  <files>crkva/registar/tests/test_migrate_data_command.py</files>
  <action>
Create `crkva/registar/tests/test_migrate_data_command.py` with `TestMigrateDataCommand(TransactionTestCase)`:

Use `TransactionTestCase` (not `TestCase`) because the command uses `call_command` which may involve transactions.

**Test cases:**

1. `test_help_shows_all_flags` — Run `call_command('migrate_data', '--help')` and capture stdout. Verify it mentions `--dummy`, `--real`, `--dry-run`, `--skip-staging`, `--keep-staging`.
   - Note: `--help` causes SystemExit, so catch it.

2. `test_no_flags_raises_error` — Run `call_command('migrate_data')` without any flags. Should raise `CommandError` because `--dummy` or `--real` is required.

3. `test_both_flags_raises_error` — Run `call_command('migrate_data', '--dummy', '--real')`. Should raise error (mutually exclusive).

4. `test_real_missing_zip_raises_error` — Run `call_command('migrate_data', '--real', '/nonexistent/path.zip')`. Should raise `CommandError` about missing file.

5. `test_dummy_dry_run_no_database_writes` — Run `call_command('migrate_data', '--dummy', '--dry-run')`. After command, verify key tables are empty (no Krstenje, Vencanje records created). Use `assertFalse(Krstenje.objects.exists())`.

6. `test_dummy_creates_data` — Run `call_command('migrate_data', '--dummy')` with `@patch` on individual `call_command` calls to verify all expected sub-commands are invoked in correct order. Use `unittest.mock.patch('django.core.management.call_command')` to avoid actual data generation in tests.
   - Verify the call order: unosi, unos_drzava, unos_mesta, ..., unos_krstenja, unos_vencanja.

7. `test_real_calls_correct_commands` — Similar mock test for `--real` path. Verify load_dbf is called first, then migration commands in correct order.

8. `test_summary_report_printed` — Capture stdout from a `--dummy --dry-run` run. Verify summary report contains expected header ("ИЗВЕШТАЈ О МИГРАЦИЈИ") and step listings.

Run tests: `python manage.py test registar.tests.test_migrate_data_command -v2`
  </action>
  <verify>
    `cd /Users/milan.jelisavcic/Projects/spc-registar/crkva && python manage.py test registar.tests.test_migrate_data_command -v2 2>&1 | tail -10` shows all tests passing.
  </verify>
  <done>8+ integration tests pass covering argument validation, mock-verified command orchestration, dry-run behavior, and summary report output.</done>
</task>

<task type="auto">
  <name>Task 2: Update MIGRACIJA.md with new workflow documentation</name>
  <files>docs/MIGRACIJA.md</files>
  <action>
Read the existing `docs/MIGRACIJA.md` to understand its current structure and content.

Update it to document the new unified workflow. The document should be written in Serbian Cyrillic (matching the existing style). Key sections to add or update:

1. **Брзи почетак (Quick Start)** section at the top:
   ```
   ## Брзи почетак

   ### За развој (тест подаци)
   docker compose run --rm app sh -c "python manage.py migrate_data --dummy"

   ### За продукцију (стварни подаци)
   docker compose run --rm app sh -c "python manage.py migrate_data --real --dry-run"
   docker compose run --rm app sh -c "python manage.py migrate_data --real"

   ### За продукцију (из специфичне путање)
   docker compose run --rm app sh -c "python manage.py migrate_data --real /path/to/crkva.zip"
   ```

2. **Опције команде (Command Options)** section:
   - `--dummy` — Генерише тест податке за развој
   - `--real [путања]` — Увози стварне податке из crkva.zip
   - `--dry-run` — Проверава податке без уписа у базу
   - `--skip-staging` — Прескаче учитавање DBF фајлова (користи постојеће staging табеле)
   - `--keep-staging` — Не брише staging табеле након миграције

3. **Редослед миграције (Migration Order)** section:
   - Document the exact step order for both --dummy and --real workflows
   - Explain why order matters (foreign key dependencies)

4. **Решавање проблема (Troubleshooting)** section:
   - crkva.zip not found error
   - Staging table collision (use --skip-staging)
   - Encoding issues (cp1250)
   - How to re-run after partial failure

5. **Preserve existing content** that is still relevant (like the detailed field mapping tables if they exist).

6. **Mark legacy commands** section explaining that individual commands (`migracija_krstenja`, etc.) still work for advanced users but `migrate_data` is the recommended approach.
  </action>
  <verify>
    Read `docs/MIGRACIJA.md` and verify it contains: "migrate_data", "--dummy", "--real", "--dry-run", "Брзи почетак" sections.
  </verify>
  <done>MIGRACIJA.md updated with new unified command documentation in Serbian Cyrillic. Quick start section at top. All flags documented. Troubleshooting section added. Legacy commands noted as still available.</done>
</task>

</tasks>

<verification>
1. `python manage.py test registar.tests.test_migrate_data_command -v2` passes all tests
2. `python manage.py test registar` passes full suite with no regressions
3. `docs/MIGRACIJA.md` contains "migrate_data", "--dummy", "--real", "--dry-run"
4. Documentation is in Serbian Cyrillic
5. Legacy command documentation preserved
</verification>

<success_criteria>
- 8+ integration tests covering happy paths, error cases, and mock-verified orchestration
- MIGRACIJA.md documents the complete new workflow
- Quick start section enables immediate use without reading the entire document
- All test suites pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-migration-workflow-simplification/01-03-SUMMARY.md`
</output>
