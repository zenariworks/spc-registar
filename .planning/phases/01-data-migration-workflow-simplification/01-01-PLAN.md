---
phase: 01-data-migration-workflow-simplification
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - crkva/registar/utils/__init__.py
  - crkva/registar/utils/migration_converters.py
  - crkva/registar/tests/test_migration_converters.py
autonomous: true

must_haves:
  truths:
    - "Konvertor conversion logic is importable from registar.utils.migration_converters"
    - "Latin-to-Cyrillic conversion produces correct Serbian Cyrillic output"
    - "Integer conversion handles edge cases (empty, None, non-numeric) safely"
    - "Date parsing from DBF format handles zero-padded and missing components"
    - "All existing migration commands can import from the new module without changes"
  artifacts:
    - path: "crkva/registar/utils/__init__.py"
      provides: "Package init for utils module"
    - path: "crkva/registar/utils/migration_converters.py"
      provides: "Konvertor class with string, int, date, and name-splitting methods"
      contains: "class Konvertor"
    - path: "crkva/registar/tests/test_migration_converters.py"
      provides: "Unit tests for all Konvertor methods"
      contains: "class TestKonvertor"
  key_links:
    - from: "crkva/registar/utils/migration_converters.py"
      to: "crkva/registar/management/commands/convert_utils.py"
      via: "Re-exports or replaces existing Konvertor"
      pattern: "class Konvertor"
---

<objective>
Extract the `Konvertor` utility class from `convert_utils.py` into a proper `registar/utils/` module and extend it with date parsing and name-splitting helpers currently duplicated across migration commands. Use TDD to ensure 80%+ coverage on all conversion methods.

Purpose: Centralizes scattered conversion logic into a tested, importable module that the unified `migrate_data` command (Plan 02) will depend on. Eliminates code duplication across 8 migration files.
Output: `registar/utils/migration_converters.py` with comprehensive test suite.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@crkva/registar/management/commands/convert_utils.py
@crkva/registar/management/commands/base_migration.py
@crkva/registar/management/commands/migracija_krstenja.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create utils module and write failing tests for Konvertor</name>
  <files>
    crkva/registar/utils/__init__.py
    crkva/registar/tests/test_migration_converters.py
  </files>
  <action>
RED phase: Write tests first, then create minimal module structure.

1. Create `crkva/registar/utils/__init__.py` (empty file to make it a package).

2. Create `crkva/registar/tests/test_migration_converters.py` with `TestKonvertor` class covering:

   **`Konvertor.string()` tests:**
   - Latin "Beograd" -> Cyrillic "Београд"
   - Mixed case "BEOGRAD" -> "БЕОГРАД"
   - Special Serbian Latin chars: "Čačak" -> "Чачак", "Šabac" -> "Шабац", "Žabalj" -> "Жабаљ"
   - Legacy HramSP encoding: "q" -> "љ", "w" -> "њ", "]" -> "Ћ", "}" -> "ћ", "\\" -> "Ђ", "|" -> "ђ", "x" -> "џ"
   - Empty string returns empty string
   - Whitespace-only string returns empty string
   - Already-Cyrillic text passes through unchanged

   **`Konvertor.int()` tests:**
   - Valid "123" -> 123
   - Empty string -> default (0)
   - None -> default (0)
   - Non-numeric "abc" -> default (0)
   - Custom default: "abc" with default=-1 -> -1
   - Float string "12.5" -> default (truncation not expected)

   **`Konvertor.date()` tests (NEW method to extract from migracija_krstenja._date):**
   - Normal date (2000, 3, 15) -> date(2000, 3, 15)
   - Zero year (0, 3, 15) -> date(1900, 3, 15)
   - Zero month (2000, 0, 15) -> date(2000, 1, 15)
   - Zero day (2000, 3, 0) -> date(2000, 3, 1)
   - All zeros (0, 0, 0) -> date(1900, 1, 1)
   - None values -> date(1900, 1, 1)

   **`Konvertor.split_name()` tests (extracted from base_migration.split_full_name):**
   - "Петар Петровић" -> ("Петар", "Петровић")
   - "СлавицаЋуковић" (no space, camelCase Cyrillic) -> ("Славица", "Ћуковић")
   - Empty string -> (None, None)
   - None -> (None, None)
   - Single word "Петар" -> (None, None)

3. Run tests with `python manage.py test registar.tests.test_migration_converters` - they MUST fail (module doesn't exist yet).
  </action>
  <verify>
    `cd /Users/milan.jelisavcic/Projects/spc-registar/crkva && python manage.py test registar.tests.test_migration_converters 2>&1 | grep -E "FAILED|ERROR|Ran"` shows test failures (ImportError or assertion errors).
  </verify>
  <done>Test file exists with 15+ test cases covering all Konvertor methods; all tests fail because the implementation module doesn't exist yet.</done>
</task>

<task type="auto">
  <name>Task 2: Implement Konvertor in migration_converters.py and pass all tests</name>
  <files>
    crkva/registar/utils/migration_converters.py
  </files>
  <action>
GREEN phase: Implement the Konvertor class to make all tests pass.

1. Create `crkva/registar/utils/migration_converters.py` with:

```python
class Konvertor:
```

**`string(text)` static method:**
- Copy the Latin-to-Cyrillic mapping from `convert_utils.py` (lines 21-89)
- Handle None input (return empty string)
- Strip whitespace before conversion
- Return converted text

**`int(value, default=0)` static method:**
- Copy from `convert_utils.py` (lines 8-14)
- Add None handling (return default)
- Use logging.warning instead of print() for non-convertible values

**`date(y, m, d)` static method (NEW):**
- Extract logic from `migracija_krstenja._date()` function
- Replace zero components: year=0 -> 1900, month=0 -> 1, day=0 -> 1
- Handle None values same as zeros
- Return `datetime.date` object

**`split_name(full_name)` static method (NEW):**
- Extract logic from `base_migration.MigrationCommand.split_full_name()`
- Split by space first, then by uppercase Cyrillic letter in middle
- Return tuple of (first_name, last_name) or (None, None)

2. Run the full test suite: `python manage.py test registar.tests.test_migration_converters`

3. All tests MUST pass.

4. Also run existing tests to ensure no regressions: `python manage.py test registar`
  </action>
  <verify>
    `cd /Users/milan.jelisavcic/Projects/spc-registar/crkva && python manage.py test registar.tests.test_migration_converters -v2 2>&1 | tail -5` shows "OK" with all tests passing.
    `cd /Users/milan.jelisavcic/Projects/spc-registar/crkva && python manage.py test registar 2>&1 | tail -3` shows no regressions.
  </verify>
  <done>All Konvertor tests pass. Existing test suite passes without regressions. `registar.utils.migration_converters.Konvertor` is importable and functional.</done>
</task>

</tasks>

<verification>
1. `python manage.py test registar.tests.test_migration_converters -v2` passes all tests
2. `python manage.py test registar` passes with no regressions
3. `from registar.utils.migration_converters import Konvertor` works in Django shell
4. `Konvertor.string("Beograd")` returns `"Београд"`
5. `Konvertor.date(0, 0, 0)` returns `date(1900, 1, 1)`
</verification>

<success_criteria>
- Konvertor class exists in `registar/utils/migration_converters.py` with 4 static methods
- 15+ unit tests covering normal, edge, and error cases
- All tests pass
- No regressions in existing test suite
- Module importable from anywhere in the Django project
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-migration-workflow-simplification/01-01-SUMMARY.md`
</output>
