{% extends "base.html" %}
{% load marker_filter phone_filters %}

{% block content %}
<div class="u-page-header">
    <a href="#" class="back-button" onclick="history.back(); return false;" aria-label="–ù–∞–∑–∞–¥" title="–ù–∞–∑–∞–¥">
        <i class="fa-solid fa-arrow-left"></i>
    </a>
    <h1 class="u-page-title">–î–æ–º–∞—õ–∏–Ω—Å—Ç–≤–∞ ({{ page_obj.paginator.count }})</h1>
    <form method="get" action="" class="form-container">
        <div>
            {% for field in form.visible_fields %}
                {{ field }}
            {% endfor %}
            <input type="submit" class="hidden-submit">
        </div>
    </form>
</div>

<ul class="spisak">
    {% for domacinstvo in domacinstva %}
        <li class="stavka stavka--expandable" data-id="{{ domacinstvo.uid }}">
            <div class="stavka__header" onclick="toggleStavka(this)">
                <div class="stavka__toggle">
                    <i class="fa-solid fa-chevron-right"></i>
                </div>
                <div class="stavka__content">
                    <div style="font-weight: 500; min-width: 200px;">
                        <i class="fa-solid fa-house" style="margin-right: 8px; color: var(--color-text-secondary);"></i>
                        {{ domacinstvo.domacin.ime|markiraj:upit|safe }} {{ domacinstvo.domacin.prezime|markiraj:upit|safe }}
                    </div>
                    {% if domacinstvo.adresa and domacinstvo.adresa.ulica %}
                    <div style="color: var(--color-text-secondary); font-size: 0.9em;">
                        üìç {{ domacinstvo.adresa.ulica.naziv|markiraj:upit|safe }} {{ domacinstvo.adresa.broj }}
                    </div>
                    {% endif %}
                    {% if domacinstvo.tel_mobilni or domacinstvo.tel_fiksni %}
                    <div style="color: var(--color-text-secondary); font-size: 0.9em;">
                        {% if domacinstvo.tel_mobilni %}
                        <a href="tel:{{ domacinstvo.tel_mobilni|tel_link }}" style="color: var(--color-primary); text-decoration: none;">
                            <i class="fa-solid {{ domacinstvo.tel_mobilni|phone_icon }}"></i>
                            {{ domacinstvo.tel_mobilni|format_phone }}
                        </a>
                        {% elif domacinstvo.tel_fiksni %}
                        <a href="tel:{{ domacinstvo.tel_fiksni|tel_link }}" style="color: var(--color-primary); text-decoration: none;">
                            <i class="fa-solid {{ domacinstvo.tel_fiksni|phone_icon }}"></i>
                            {{ domacinstvo.tel_fiksni|format_phone }}
                        </a>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% if domacinstvo.slava %}
                    <div style="color: var(--color-slava-text); font-size: 0.9em; background: var(--color-slava-bg); padding: 2px 8px; border-radius: 3px;">
                        {{ domacinstvo.slava }}
                    </div>
                    {% endif %}
                    <div style="color: var(--color-text-secondary); font-size: 0.9em;">
                        <i class="fa-solid fa-users" style="margin-right: 4px;"></i>
                        {{ domacinstvo.ukucani.count }} —á–ª.
                    </div>
                </div>
            </div>
            <div class="stavka__expandable-section">
                {% with ukucani=domacinstvo.ukucani.all %}
                    {% if ukucani %}
                        <div style="padding-top: 10px;">
                            <strong style="display: block; margin-bottom: 10px; color: var(--color-text-secondary);">–ß–ª–∞–Ω–æ–≤–∏ –¥–æ–º–∞—õ–∏–Ω—Å—Ç–≤–∞:</strong>
                            {% for ukucanin in ukucani %}
                                <div class="stavka__member {% if ukucanin.preminuo %}stavka__member--deceased{% endif %}">
                                    <div class="stavka__member-name">
                                        {% if ukucanin.osoba %}
                                            <a href="{% url 'parohijan_detail' uid=ukucanin.osoba.uid %}">
                                                {{ ukucanin.osoba.ime }} {{ ukucanin.osoba.prezime }}
                                            </a>
                                        {% else %}
                                            {{ ukucanin.ime_ukucana }}
                                        {% endif %}
                                        {% if ukucanin.preminuo %} <span style="color: var(--color-text-muted);">‚Ä†</span>{% endif %}
                                    </div>
                                    <div class="stavka__member-role">
                                        <span class="stavka__member-role-badge">
                                            {{ ukucanin.get_uloga_display }}
                                        </span>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p style="color: var(--color-text-secondary); margin-top: 10px;">–ù–µ–º–∞ –ø–æ–¥–∞—Ç–∞–∫–∞ –æ —á–ª–∞–Ω–æ–≤–∏–º–∞.</p>
                    {% endif %}
                {% endwith %}
                <a href="{% url 'domacinstvo_detail' uid=domacinstvo.uid %}" class="button button--primary" style="margin-top: 10px;">
                    <i class="fa-solid fa-arrow-right"></i> –î–µ—Ç–∞—ô–Ω–∏ –ø—Ä–∏–∫–∞–∑
                </a>
            </div>
        </li>
    {% empty %}
        <li>–ù–µ–º–∞ —É–ø–∏—Å–∞–Ω–∏—Ö –¥–æ–º–∞—õ–∏–Ω—Å—Ç–∞–≤–∞ —É –±–∞–∑–∏.</li>
    {% endfor %}
</ul>

<div class="pagination">
    <span class="step-links">
        {% if page_obj.has_previous %}
            <a href="?page=1{% if upit %}&search={{ upit }}{% endif %}" class="page-link">&laquo; –ø—Ä–≤–∞</a>
            <a href="?page={{ page_obj.previous_page_number }}{% if upit %}&search={{ upit }}{% endif %}" class="page-link">–ø—Ä–µ—Ç—Ö–æ–¥–Ω–∞</a>
        {% endif %}

        <span class="current">
            —Å—Ç—Ä–∞–Ω–∞ {{ page_obj.number }} –æ–¥ {{ page_obj.paginator.num_pages }}.
        </span>

        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if upit %}&search={{ upit }}{% endif %}" class="page-link">—Å–ª–µ–¥–µ—õ–∞</a>
            <a href="?page={{ page_obj.paginator.num_pages }}{% if upit %}&search={{ upit }}{% endif %}" class="page-link">–ø–æ—Å–ª–µ–¥—ö–∞ &raquo;</a>
        {% endif %}
    </span>
</div>

<script>
    function toggleStavka(header) {
        const stavka = header.closest('.stavka');
        stavka.classList.toggle('stavka--expanded');
    }
</script>
{% endblock %}
