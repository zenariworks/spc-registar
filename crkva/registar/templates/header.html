<!-- header.html -->
{% load static %}
<header>
  <div class="container header-bar">
    <button class="hamburger-menu" onclick="toggleMenu()" aria-label="Отвори мени">
      <i class="fa-solid fa-bars"></i>
    </button>
    <div class="fusion-logo">
       <a href="{% url 'pocetna' %}">
       <img src="https://spc.rs/wp-content/uploads/2022/03/spc-logo.png" alt="Logo СПЦ">
       </a>
    </div>
    <div class="menu-search-wrapper">
       <nav id="menu" aria-label="Главни мени">
         <ul>
         {% url 'parohijani' as parohijani_url %}
         {% url 'krstenja' as krstenja_url %}
         {% url 'vencanja' as vencanja_url %}
         {% url 'svestenici' as svestenici_url %}
         {% url 'slava_kalendar' as slava_kalendar_url %}
         {% url 'unos_krstenja' as unos_krstenja_url %}
         {% url 'unos_vencanja' as unos_vencanja_url %}
         {% url 'unos_parohijana' as unos_parohijana_url %}
         <li class="has-dropdown">
            <button type="button" class="menu-item-toggle" aria-expanded="false" aria-controls="dropdown-lists">
              Спискови <i class="fa-solid fa-chevron-down" aria-hidden="true"></i>
            </button>
            <ul class="dropdown" id="dropdown-lists">
               <li><a href="{{ parohijani_url }}" class="{% if request.path == parohijani_url %}active{% endif %}">Парохијани</a></li>
               <li><a href="{{ krstenja_url }}" class="{% if request.path == krstenja_url %}active{% endif %}">Крштења</a></li>
               <li><a href="{{ vencanja_url }}" class="{% if request.path == vencanja_url %}active{% endif %}">Венчања</a></li>
               <li><a href="{{ svestenici_url }}" class="{% if request.path == svestenici_url %}active{% endif %}">Свештеници</a></li>
               <li><a href="{{ slava_kalendar_url }}" class="{% if request.path == slava_kalendar_url %}active{% endif %}">Календар слава</a></li>
            </ul>
         </li>
         <li class="has-dropdown">
            <button type="button" class="menu-item-toggle" aria-expanded="false" aria-controls="dropdown-entries">
              Уноси <i class="fa-solid fa-chevron-down" aria-hidden="true"></i>
            </button>
            <ul class="dropdown" id="dropdown-entries">
               <li><a href="{{ unos_krstenja_url }}" class="{% if request.path == unos_krstenja_url %}active{% endif %}">Крштење</a></li>
               <li><a href="{{ unos_vencanja_url }}" class="{% if request.path == unos_vencanja_url %}active{% endif %}">Венчање</a></li>
               <li><a href="{{ unos_parohijana_url }}" class="{% if request.path == unos_parohijana_url %}active{% endif %}">Парохијан</a></li>
            </ul>
         </li>
           <li class="theme-icon">
              <a href="#" id="theme-toggle" class="fusion-main-menu-icon" aria-label="Промени тему" title="Промени тему">
                <i class="fa-solid fa-sun"></i>
              </a>
           </li>
           <li class="search-icon">
              <a href="#" id="search-trigger" class="fusion-main-menu-icon">
              <i class="fa-solid fa-magnifying-glass"></i>
              </a>
           </li>
        </ul>
       </nav>
       <div id="search-overlay" style="display: none;">
         <form method="get" action="{% url 'search_view' %}" class="search-form">
            <div class="search-box">
               <button type="submit" class="search-icon-button"><i class="fa-solid fa-magnifying-glass"></i></button>
               <input type="text" name="query" placeholder="Претрага..." autofocus>
               <a href="#" id="close-search" class="close-search"><i class="fa-solid fa-xmark"></i></a>
            </div>
         </form>
       </div>
    </div>
  </div>
  <div id="menu-backdrop"></div>
  <script>
     document.getElementById('search-trigger').addEventListener('click', function(event) {
       event.preventDefault();
       document.getElementById("menu").style.display = "none";
       document.getElementById('search-overlay').style.display = 'flex';
     });

     document.getElementById('close-search').addEventListener('click', function(event) {
       event.preventDefault();
       document.getElementById('search-overlay').style.display = 'none';
       document.getElementById("menu").style.display = "flex";
     });
     // ESC zatvara pretragu
     document.addEventListener('keydown', function(event) {
       if (event.key === 'Escape') {
         document.getElementById('search-overlay').style.display = 'none';
         document.getElementById("menu").style.display = "flex";
       }
     });
     // Klik van polja zatvara pretragu
     document.addEventListener('click', function(event) {
       const overlay = document.getElementById('search-overlay');
       const searchTrigger = document.getElementById('search-trigger');
       if (!overlay.contains(event.target) && event.target !== searchTrigger) {
         if (overlay.style.display === 'flex') {
           overlay.style.display = 'none';
           document.getElementById("menu").style.display = "flex";
         }
       }
     });

     // Theme toggle
     (function() {
       var toggle = document.getElementById('theme-toggle');
       var iconEl = toggle ? toggle.querySelector('i') : null;

       function setTheme(t) {
         document.documentElement.setAttribute('data-theme', t);
         try { localStorage.setItem('theme', t); } catch(e){}
       }
       function getTheme() {
         return document.documentElement.getAttribute('data-theme') || 'light';
       }
       function updateThemeIcon() {
         var current = getTheme();
         if (!iconEl) return;
         if (current === 'dark') {
           iconEl.className = 'fa-solid fa-moon';
           toggle.setAttribute('aria-label', 'Промени тему: светла');
           toggle.setAttribute('title', 'Промени на светлу тему');
           toggle.setAttribute('aria-pressed', 'true');
         } else {
           iconEl.className = 'fa-solid fa-sun';
           toggle.setAttribute('aria-label', 'Промени тему: тамна');
           toggle.setAttribute('title', 'Промени на тамну тему');
           toggle.setAttribute('aria-pressed', 'false');
         }
       }

       // Initialize icon on load
       if (toggle) {
         updateThemeIcon();
         toggle.addEventListener('click', function(event) {
           event.preventDefault();
           var next = getTheme() === 'dark' ? 'light' : 'dark';
           setTheme(next);
           updateThemeIcon();
         });
       }
     })();
     function toggleMenu() {
       var menu = document.getElementById("menu");
       var backdrop = document.getElementById("menu-backdrop");
       if (menu.classList.contains("open")) {
           menu.classList.remove("open");
           backdrop.classList.remove("active");
       } else {
           menu.classList.add("open");
           backdrop.classList.add("active");
       }
     }

     // Close menu when clicking backdrop
     document.addEventListener('DOMContentLoaded', function() {
       var backdrop = document.getElementById("menu-backdrop");
       if (backdrop) {
         backdrop.addEventListener('click', function() {
           var menu = document.getElementById("menu");
           menu.classList.remove("open");
           backdrop.classList.remove("active");
         });
       }
     });

     // Mobile-friendly dropdown toggles
     (function(){
       function setupDropdownToggles(){
         var toggles = document.querySelectorAll('.menu-item-toggle');
         toggles.forEach(function(btn){
           btn.addEventListener('click', function(e){
             e.preventDefault();
             var expanded = btn.getAttribute('aria-expanded') === 'true';
             btn.setAttribute('aria-expanded', (!expanded).toString());
             var dropdown = btn.nextElementSibling;
             if (dropdown) {
               dropdown.classList.toggle('open', !expanded);
             }
           });
         });

         // Close when clicking outside
         document.addEventListener('click', function(e){
           toggles.forEach(function(btn){
             var dropdown = btn.nextElementSibling;
             if (!btn.contains(e.target) && dropdown && !dropdown.contains(e.target)) {
               btn.setAttribute('aria-expanded','false');
               dropdown.classList.remove('open');
             }
           });
         });
       }
       if (document.readyState === 'loading') {
         document.addEventListener('DOMContentLoaded', setupDropdownToggles);
       } else {
         setupDropdownToggles();
       }
     })();
  </script>
</header>
